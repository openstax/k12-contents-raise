version: 0.2

env:
  shell: bash
  secrets-manager:
    SLACK_WEBHOOKURL: "slack:k12stream"
phases:
  build:
    commands:
      - pip install git+https://github.com/openstax/raise-mbtools@93a6886
      - mkdir json && html-to-json html json
      - aws s3 cp --cache-control max-age=86400 --recursive json/ "s3://$CONTENT_S3_BUCKET/contents/raise/${COMMIT_ID:0:8}/"
      - aws s3 cp --cache-control no-cache --recursive json/ "s3://$CONTENT_S3_BUCKET/contents/raise/latest/"
    on-failure: ABORT
    finally:
      - "([[ $CODEBUILD_BUILD_SUCCEEDING != 1 ]] && curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"Error in k12-contents-raise pipeline!\"}' $SLACK_WEBHOOKURL) || true"
  post_build:
    commands:
      - ls json/ > json_files.txt
      - export SLACK_MESSAGE="k12-contents-raise deployment completed for commit $COMMIT_ID"
      - "curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"'\"$SLACK_MESSAGE\"'\"}' $SLACK_WEBHOOKURL"
artifacts:
  files:
    - json_files.txt
